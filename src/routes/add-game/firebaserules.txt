match /users/{userId} {
      	allow read;
        allow create: if isValidUser(userId);
        allow update: if request.auth.uid == userId;
      }
      
      function isValidUser(userId) {
        let isOwner = request.auth.uid == userId;
      	let username = request.resource.data.username;
        let createdValidUsername = existsAfter(/databases/$(database)/documents/usernames/$(username));
        
        return isOwner && createdValidUsername;
      }
      
      match /homegames/{document} {
     		allow read: if request.auth != null;
    	}
      
      match /databases/{database}/documents {
    		match /users/{userId} {
      		allow read, write: if request.auth != null && request.auth.uid == userId;
    		}
    		match /homegames/{homegameId} {
      		allow read: if request.auth != null;
      		allow create, update, delete: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
    		}
  		}
  }